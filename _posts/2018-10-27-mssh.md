---
layout:       post
title:        "一个用户管理多个 ssh key"
subtitle:     "How does a user manage multiple SSH key?"
date:         "2018-10-21"
header-img:   "img/post/city.jpeg"
header-mask:  0.20
catalog:      true
tags:
    - ssh
---

## 问题
有时候，我们需要使用多少个不同 ssh-key 来登录相同或不同服务器上的不同的用户。比如说，我同时需要 3 个 ssh-key 来登录 github、coding 和一台远程主机。这种情况下我们就需要同时在本地主机中存放三个 ssh-key， 如果不能有效的管理它们，那么每次可用的秘钥只有一个，切换账户的过程就意味需要重新生成一份秘钥，不仅麻烦，甚至还会造成混乱，导致 ssh-key 无法正常工作。

## 解决方法
通过 ssh-agent 进行代理

ssh-agent 是 linux 系统上的一个程序，这个程序可以控制和保存公钥身份验证所使用的私钥程序，听起来好拗口。

我们通过 ssh-add 把私钥提交给 ssh-agent 来管理时，其他程序需要身份验证的时候都可以申请交给 ssh-agent 来完成整个认证过程。所以，到这里我们应该大体了解 ssh-agent 它就是一个帮助我们验证身份的程序

### 1 为不同账户生成不同密钥对
就刚刚做出的问题，下面分别为上述三个账户生成 rsa 密钥对
```sh
# 将 $your_email 替换为你的 email
rsa-keygen -t rsa -C "$your_email" -f ~/.ssh/id_rsa_github
rsa-keygen -t rsa -C "$your_email" -f ~/.ssh/id_rsa_coding
rsa-keygen -t rsa -N "" -f ~/.ssh/id_rsa_remotehost
```

然后我们就可以在 `~/.shh` 目录下看到我们刚刚生成的三个密钥对

### 2 查看 ssh-key 代理
执行如下命令进行查看
```sh
excut ssh-agent bash
ssh-add -l
```
如果系统已经有ssh-key 代理 ，执行下面的命令可以删除
```sh
ssh-add -D
```
### 3 添加私钥到 ssh-agent
依次执行以下命令，把三个私钥添加到 ssh-key 代理里
```sh
ssh-add ~/.ssh/id_rsa_github
ssh-add ~/.ssh/id_rsa_coding
ssh-add ~/.ssh/id_rsa_remotehost
```
### 4 提交公钥到服务器
登录 github 和 coding 的 ssh 管理页面，把对应的公钥提交保存到代码管理服务器 (公钥以 `.pub` 结尾)
对于远程主机，我们执行以下命令将公钥复制到授权文件
```sh
ssh-copy-id -i ~/.ssh/id_rsa_remotehost remoteuser@remotehost
```
然后输入 remoteuser 的密码即可

### 5 创建配置文件
在 `~/.ssh` 下创建一个配置文件 `config`
```sh
vim ~/.ssh/config
```
输入如下配置信息
```conf
# github settings
Host github
    HostName git.github.com
    User username
    IdentityFile ~/.ssh/id_rsa_github

# coding settings
Host coding
    HostName git.coding.net
    User username
    IdentityFile ~/.ssh/id_rsa_coding

# remotehost settings
Host remotehost
    HostName remotehost
    User remoteuser
    IdentityFile ~/.ssh/id_rsa_remotehost
```
### 6 完成
使用 Host 里设置的别名，开始克隆项目，以 coding 为例
```sh
git clone git@git.coding.net:userName/projectName.git
```